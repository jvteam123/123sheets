<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lite Project Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .bg-slate-900 {
            background-color: #0F172A;
        }
        .text-white {
            color: #FFFFFF;
        }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { IDBKeyRange } = window;

        const dbName = 'LiteTimeTrackerDB';
        const dbVersion = 1;
        const objectStoreName = 'projects';
        const staticUserId = 'test_user_id_1';

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(objectStoreName)) {
                        db.createObjectStore(objectStoreName, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    reject('IndexedDB error: ' + event.target.error);
                };
            });
        };

        const addProjectsToDB = (projectsToAdd) => {
            return new Promise(async (resolve, reject) => {
                const db = await openDB();
                const transaction = db.transaction([objectStoreName], 'readwrite');
                const store = transaction.objectStore(objectStoreName);
                
                projectsToAdd.forEach(project => {
                    const id = Date.now() + Math.random();
                    store.add({ ...project, id });
                });

                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject(event.target.error);
            });
        };

        const getProjectsFromDB = () => {
            return new Promise(async (resolve, reject) => {
                const db = await openDB();
                const transaction = db.transaction([objectStoreName], 'readonly');
                const store = transaction.objectStore(objectStoreName);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        };

        const updateProjectInDB = (project) => {
            return new Promise(async (resolve, reject) => {
                const db = await openDB();
                const transaction = db.transaction([objectStoreName], 'readwrite');
                const store = transaction.objectStore(objectStoreName);
                store.put(project);
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject(event.target.error);
            });
        };

        const deleteProjectFromDB = (id) => {
            return new Promise(async (resolve, reject) => {
                const db = await openDB();
                const transaction = db.transaction([objectStoreName], 'readwrite');
                const store = transaction.objectStore(objectStoreName);
                store.delete(id);
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject(event.target.error);
            });
        };

        const PlayIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        );

        const StopIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
          </svg>
        );
        
        const PauseIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        );

        const PlusIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinecap="round" strokeLinejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        );

        const Trash2Icon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        );

        const EditIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
          </svg>
        );

        const SaveIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
        );

        const XIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        );

        const ResetIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 12a9 9 0 1 1-9-9c2.72 0 5.06 1.154 6.74 3.03l-1.42 1.42"></path>
            <path d="M21 12V3h-9"></path>
          </svg>
        );

        const formatDuration = (milliseconds) => {
          if (milliseconds === null || milliseconds === undefined || isNaN(milliseconds)) {
            return '0m';
          }
          const totalSeconds = Math.floor(milliseconds / 1000);
          const minutes = Math.floor(totalSeconds / 60);
          const seconds = totalSeconds % 60;
          return `${minutes}m ${seconds}s`;
        };

        const formatTotalMinutes = (milliseconds) => {
          if (milliseconds === null || milliseconds === undefined || isNaN(milliseconds)) {
            return '0 mins';
          }
          const totalMinutes = Math.round(milliseconds / (1000 * 60));
          return `${totalMinutes} mins`;
        };
        
        const formatMillisecondsToHours = (milliseconds) => {
            if (milliseconds === null || milliseconds === undefined || isNaN(milliseconds)) {
                return '0.00';
            }
            const totalHours = milliseconds / (1000 * 60 * 60);
            return totalHours.toFixed(2);
        };

        const FIX_CATEGORIES = {
            ORDER: ["Fix1", "Fix2", "Fix3", "Fix4", "Fix5", "Fix6"],
        };
        
        const getTaskTotalDuration = (project) => {
            let totalMs = 0;
            let totalBreaks = 0;
            for(let i = 1; i <= 6; i++) {
                totalMs += (project[`durationDay${i}Ms`] || 0);
                totalBreaks += (project[`breakDurationMinutesDay${i}`] || 0) * 60 * 1000;
            }
            return Math.max(0, totalMs - totalBreaks);
        };

        const getCurrentDay = (project) => {
            const status = project.status;
            if (status.startsWith('InProgressDay')) {
                return parseInt(status.match(/(\d+)/)[1], 10);
            } else if (status.startsWith('Day') && status.includes('Ended')) {
                return parseInt(status.match(/(\d+)/)[1], 10);
            }
            return 0;
        };

        const formatTimeForInput = (milliseconds) => {
            if (!milliseconds) return '';
            const date = new Date(milliseconds);
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        };
        
        function App() {
          const [projects, setProjects] = useState([]);
          const [selectedProjectName, setSelectedProjectName] = useState('');
          const [selectedTaskId, setSelectedTaskId] = useState('');
          const [selectedDay, setSelectedDay] = useState(1);
          const [runningProjectId, setRunningProjectId] = useState(null);
          const [elapsedTime, setElapsedTime] = useState(0);
          const [isTLView, setIsTLView] = useState(false);
          const [newProjectName, setNewProjectName] = useState('');
          const [numNewTasks, setNumNewTasks] = useState(1);
          const [currentModal, setCurrentModal] = useState(null);
          const [modalData, setModalData] = useState({});
          const [lastActionTime, setLastActionTime] = useState(null);
          const [editingProjectId, setEditingProjectId] = useState(null);

          const fetchProjects = async () => {
              try {
                  const fetchedProjects = await getProjectsFromDB();
                  setProjects(fetchedProjects);
              } catch (error) {
                  console.error("Error fetching projects from IndexedDB:", error);
              }
          };

          // Initialize IndexedDB and fetch projects
          useEffect(() => {
              const initializeAndFetch = async () => {
                  try {
                      const db = await openDB();
                      const transaction = db.transaction([objectStoreName], 'readonly');
                      const store = transaction.objectStore(objectStoreName);
                      const countRequest = store.count();

                      countRequest.onsuccess = (event) => {
                          if (event.target.result === 0) {
                              console.log("IndexedDB is empty. Adding a default test project.");
                              const projectsToAdd = [];
                              const projectName = "Test Project";
                              const numTasks = 10;
                              
                              for (let i = 1; i <= numTasks; i++) {
                                projectsToAdd.push({
                                    id: Date.now() + Math.random(),
                                    baseProjectName: projectName,
                                    areaTask: `Area${String(i).padStart(2, '0')}`,
                                    fixCategory: "Fix1",
                                    gsd: "3in",
                                    assignedTo: "",
                                    status: "Available",
                                    durationDay1Ms: null,
                                    startTimeDay1: null,
                                    finishTimeDay1: null,
                                    breakDurationMinutesDay1: 0,
                                    durationDay2Ms: null,
                                    startTimeDay2: null,
                                    finishTimeDay2: null,
                                    breakDurationMinutesDay2: 0,
                                    durationDay3Ms: null,
                                    startTimeDay3: null,
                                    finishTimeDay3: null,
                                    breakDurationMinutesDay3: 0,
                                    isLocked: false,
                                    isReassigned: false,
                                    releasedToNextStage: false,
                                    creationTimestamp: new Date(),
                                    lastModifiedTimestamp: new Date()
                                });
                              }
                              addProjectsToDB(projectsToAdd).then(() => fetchProjects());
                          } else {
                              fetchProjects();
                          }
                      };
                      countRequest.onerror = (event) => {
                          console.error("Error counting projects:", event.target.error);
                      };
                  } catch (error) {
                      console.error("Error initializing IndexedDB:", error);
                  }
              };
              initializeAndFetch();
          }, []);

          // Set up timer logic
          useEffect(() => {
            let interval;
            const currentProject = projects.find(p => p.id === runningProjectId);

            if (currentProject) {
                const currentDay = getCurrentDay(currentProject);
                const startTime = currentProject[`startTimeDay${currentDay}`];

                if (startTime && !lastActionTime) {
                    setLastActionTime(Date.now());
                }

                if (currentProject.status.startsWith('InProgressDay') && lastActionTime) {
                    interval = setInterval(() => {
                        setElapsedTime(Date.now() - lastActionTime);
                    }, 1000);
                } else {
                    setElapsedTime(0);
                }
            } else {
                setElapsedTime(0);
            }

            return () => clearInterval(interval);
          }, [runningProjectId, projects, lastActionTime]);

          const handleStartOrEndTimer = async () => {
            if (runningProjectId) { // End the current day
              const project = projects.find(p => p.id === runningProjectId);
              const currentDay = getCurrentDay(project);
              const dayDurationField = `durationDay${currentDay}Ms`;
              const dayFinishField = `finishTimeDay${currentDay}`;
              const nextStatus = `Day${currentDay}Ended_AwaitingNext`;

              const currentTime = Date.now();
              const newDurationMs = (project[dayDurationField] || 0) + (currentTime - lastActionTime);

              const updatedProject = {
                  ...project,
                  status: nextStatus,
                  [dayDurationField]: newDurationMs,
                  [dayFinishField]: currentTime,
                  lastModifiedTimestamp: new Date(),
              };
              await updateProjectInDB(updatedProject);
              setRunningProjectId(null);
              setLastActionTime(null);
              fetchProjects();
            } else { // Start a new day
                if (!selectedTaskId) {
                    console.warn("Cannot start timer: Task not selected.");
                    return;
                }
                const project = projects.find(p => p.id === selectedTaskId);
                if (!project) return;
                
                const currentDay = parseInt(selectedDay, 10);
                const currentStatus = project.status;
                
                // If a day is already in progress, don't start a new one
                if (currentStatus.startsWith('InProgressDay')) {
                    return;
                }

                const updatedProject = {
                    ...project,
                    status: `InProgressDay${currentDay}`,
                    [`startTimeDay${currentDay}`]: Date.now(),
                    assignedTo: staticUserId,
                    lastModifiedTimestamp: new Date(),
                };
                
                if (currentStatus === 'Paused') {
                  const pausedDay = getCurrentDay(project);
                  updatedProject.status = `InProgressDay${pausedDay}`;
                  updatedProject[`startTimeDay${pausedDay}`] = Date.now();
                }

                await updateProjectInDB(updatedProject);
                setRunningProjectId(project.id);
                setLastActionTime(Date.now());
                fetchProjects();
            }
          };

          const handlePauseResumeTimer = async (project) => {
            if (!project) return;
            const currentDay = getCurrentDay(project);
            const dayDurationField = `durationDay${currentDay}Ms`;
            const updatedProject = { ...project };

            if (project.status.startsWith('InProgressDay')) { // Pause
                const currentTime = Date.now();
                const newDurationMs = (project[dayDurationField] || 0) + (currentTime - lastActionTime);
                updatedProject.status = 'Paused';
                updatedProject[dayDurationField] = newDurationMs;
                setRunningProjectId(null);
                setLastActionTime(null);
            } else if (project.status === 'Paused') { // Resume
                updatedProject.status = `InProgressDay${currentDay}`;
                setRunningProjectId(project.id);
                setLastActionTime(Date.now());
            }

            await updateProjectInDB(updatedProject);
            fetchProjects();
          };

          const handleAddProject = async (e) => {
            e.preventDefault();
            if (!newProjectName.trim() || numNewTasks < 1) return;

            try {
              const projectsToAdd = [];
              const projectName = newProjectName.trim();
              const batchId = `batch_${Date.now()}`;

              for (let i = 1; i <= numNewTasks; i++) {
                projectsToAdd.push({
                  id: Date.now() + Math.random(),
                  batchId,
                  baseProjectName: projectName,
                  areaTask: `Area${String(i).padStart(2, '0')}`,
                  fixCategory: "Fix1",
                  gsd: "3in",
                  assignedTo: "",
                  status: "Available",
                  durationDay1Ms: null,
                  startTimeDay1: null,
                  finishTimeDay1: null,
                  breakDurationMinutesDay1: 0,
                  durationDay2Ms: null,
                  startTimeDay2: null,
                  finishTimeDay2: null,
                  breakDurationMinutesDay2: 0,
                  durationDay3Ms: null,
                  startTimeDay3: null,
                  finishTimeDay3: null,
                  breakDurationMinutesDay3: 0,
                  isLocked: false,
                  isReassigned: false,
                  releasedToNextStage: false,
                  creationTimestamp: new Date(),
                  lastModifiedTimestamp: new Date()
                });
              }

              await addProjectsToDB(projectsToAdd);
              setNewProjectName('');
              setNumNewTasks(1);
              fetchProjects();
            } catch (error) {
              console.error("Error adding projects:", error);
            }
          };

          const handleDeleteProject = async (id) => {
              try {
                await deleteProjectFromDB(id);
                fetchProjects();
              } catch (error) {
                console.error("Error deleting project:", error);
              }
          };
          
          const handleUpdateBreaks = async (projectId, day, value) => {
              const project = projects.find(p => p.id === projectId);
              if (!project) return;
              
              const updatedProject = {
                  ...project,
                  [`breakDurationMinutesDay${day}`]: parseInt(value, 10) || 0,
                  lastModifiedTimestamp: new Date(),
              };

              await updateProjectInDB(updatedProject);
              fetchProjects();
          };
          
          const handleUpdateStartTime = async (projectId, day, value) => {
              const project = projects.find(p => p.id === projectId);
              if (!project) return;
              
              const [hours, minutes] = value.split(':').map(Number);
              const newDate = new Date(project[`startTimeDay${day}`] || new Date());
              newDate.setHours(hours, minutes, 0, 0);

              const updatedProject = {
                  ...project,
                  [`startTimeDay${day}`]: newDate.getTime(),
                  lastModifiedTimestamp: new Date(),
              };
              
              // Recalculate duration if a finish time already exists
              const finishTime = project[`finishTimeDay${day}`];
              if (finishTime && newDate.getTime() < finishTime) {
                  const newDurationMs = finishTime - newDate.getTime();
                  updatedProject[`durationDay${day}Ms`] = newDurationMs;
              }

              await updateProjectInDB(updatedProject);
              fetchProjects();
          };

          const handleReleaseToNextFix = async (project) => {
            if (!project) return;
            const currentFixIndex = FIX_CATEGORIES.ORDER.indexOf(project.fixCategory);
            if (currentFixIndex < 0 || currentFixIndex >= FIX_CATEGORIES.ORDER.length - 1) return;

            const nextFixCategory = FIX_CATEGORIES.ORDER[currentFixIndex + 1];

            try {
              const newProject = {
                id: Date.now() + Math.random(),
                ...project,
                fixCategory: nextFixCategory,
                status: "Available",
                durationDay1Ms: null,
                startTimeDay1: null,
                finishTimeDay1: null,
                durationDay2Ms: null,
                startTimeDay2: null,
                finishTimeDay2: null,
                durationDay3Ms: null,
                startTimeDay3: null,
                finishTimeDay3: null,
                isLocked: false,
                isReassigned: false,
                releasedToNextStage: false,
                breakDurationMinutesDay1: 0,
                breakDurationMinutesDay2: 0,
                breakDurationMinutesDay3: 0,
                creationTimestamp: new Date(),
                lastModifiedTimestamp: new Date(),
              };

              await addProjectsToDB([newProject]);

              const originalProject = {
                ...project,
                releasedToNextStage: true
              };

              await updateProjectInDB(originalProject);
              fetchProjects();

            } catch (error) {
              console.error("Error releasing to next fix:", error);
            }
          };

          const showConfirmationModal = (action, data) => {
            setCurrentModal('confirmation');
            setModalData({ action, ...data });
          };

          const handleModalAction = async () => {
            if (modalData.action === 'delete') {
              await handleDeleteProject(modalData.id);
            } else if (modalData.action === 'release') {
              const project = projects.find(p => p.id === modalData.id);
              await handleReleaseToNextFix(project);
            }
            setCurrentModal(null);
            setModalData({});
          };

          const runningProject = projects.find(p => p.assignedTo === staticUserId && p.status.startsWith('InProgressDay'));
          const uniqueProjectNames = Array.from(new Set(projects.map(p => p.baseProjectName)));
          const availableTasksForSelectedProject = selectedProjectName 
            ? projects.filter(p => p.baseProjectName === selectedProjectName && (p.status.startsWith('Available') || p.status.startsWith('Day')))
            : [];
          
          const totalTimePerProject = projects.reduce((acc, project) => {
              const projectName = project.baseProjectName;
              const fixCat = project.fixCategory;
              const durationMs = getTaskTotalDuration(project);

              if (!acc[projectName]) {
                  acc[projectName] = {};
              }
              if (!acc[projectName][fixCat]) {
                  acc[projectName][fixCat] = 0;
              }
              acc[projectName][fixCat] += durationMs;
              return acc;
          }, {});
          
          const sortedProjects = [...projects].sort((a, b) => {
            const nameA = a.baseProjectName || "";
            const nameB = b.baseProjectName || "";
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
          });
        
          return (
            <div className="min-h-screen bg-slate-900 text-white p-6 md:p-12 font-inter flex flex-col items-center">
              <div className="max-w-4xl w-full">
                <div className="flex justify-center mb-6 space-x-4">
                  <button
                    onClick={() => setIsTLView(false)}
                    className={`px-6 py-2 rounded-full font-bold transition-colors ${!isTLView ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                  >
                    My Tracker
                  </button>
                  <button
                    onClick={() => setIsTLView(true)}
                    className={`px-6 py-2 rounded-full font-bold transition-colors ${isTLView ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                  >
                    TL Portal
                  </button>
                </div>
        
                {isTLView ? (
                  // TL Portal View
                  <div className="space-y-8">
                    <h1 className="text-4xl font-bold text-center text-indigo-400">TL Portal</h1>
                    
                    <div className="bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg border border-slate-700">
                      <h2 className="text-xl font-semibold mb-4 text-slate-300">Add New Project</h2>
                      <form onSubmit={handleAddProject} className="flex flex-col gap-4">
                        <input
                          type="text"
                          value={newProjectName}
                          onChange={(e) => setNewProjectName(e.target.value)}
                          placeholder="Enter project name..."
                          className="bg-slate-700 text-white p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          required
                        />
                        <input
                          type="number"
                          value={numNewTasks}
                          onChange={(e) => setNumNewTasks(e.target.value)}
                          min="1"
                          placeholder="Number of tasks"
                          className="bg-slate-700 text-white p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          required
                        />
                        <button
                          type="submit"
                          className="bg-indigo-600 text-white p-3 rounded-xl flex items-center justify-center shadow-md hover:bg-indigo-500 transition-colors"
                        >
                          <PlusIcon className="mr-2" /> Add Project
                        </button>
                      </form>
                    </div>
        
                    <div className="bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg border border-slate-700">
                        <h2 className="text-xl font-semibold mb-4 text-slate-300">Project Summary</h2>
                        {Object.keys(totalTimePerProject).length === 0 ? (
                            <p className="text-center text-slate-500 italic">No projects with recorded time found.</p>
                        ) : (
                            <ul className="space-y-4">
                                {Object.keys(totalTimePerProject).map(projectName => (
                                    <li key={projectName} className="bg-slate-700 p-4 rounded-xl shadow-md">
                                        <h3 className="text-lg font-bold text-indigo-300 mb-2">{projectName}</h3>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-sm text-slate-400">
                                            {Object.keys(totalTimePerProject[projectName]).map(fixCat => (
                                                <div key={fixCat} className="bg-slate-600 p-2 rounded-md">
                                                    <span className="font-semibold text-slate-300">{fixCat}:</span>
                                                    <p className="font-mono">{formatTotalMinutes(totalTimePerProject[projectName][fixCat])} ({formatMillisecondsToHours(totalTimePerProject[projectName][fixCat])} hrs)</p>
                                                </div>
                                            ))}
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
        
                    <div className="bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg border border-slate-700">
                      <h2 className="text-xl font-semibold mb-4 text-slate-300">Manage All Projects</h2>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                          <thead className="bg-slate-700">
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Project</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Task</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Fix</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Time</th>
                              <th className="px-6 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Actions</th>
                            </tr>
                          </thead>
                          <tbody className="bg-slate-800 divide-y divide-slate-700">
                            {sortedProjects.length === 0 ? (
                              <tr>
                                <td colSpan="6" className="text-center text-slate-500 italic py-4">No projects found.</td>
                              </tr>
                            ) : (
                              sortedProjects.map((project) => (
                                <tr key={project.id} className="hover:bg-slate-700 transition-colors">
                                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-300">{project.baseProjectName}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-400">{project.areaTask}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-400">{project.fixCategory}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                      project.status === 'Available' ? 'bg-green-100 text-green-800' :
                                      project.status.startsWith('InProgressDay') ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-slate-100 text-slate-800'
                                    }`}>
                                      {project.status}
                                    </span>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-400">{formatTotalMinutes(getTaskTotalDuration(project))}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                    <button
                                      onClick={() => showConfirmationModal('delete', { id: project.id, name: project.baseProjectName })}
                                      className="text-red-400 hover:text-red-600"
                                      aria-label="Delete Project"
                                    >
                                      <Trash2Icon className="w-5 h-5" />
                                    </button>
                                    {project.status === 'Day1Ended_AwaitingNext' && (
                                        <button
                                          onClick={() => showConfirmationModal('release', { id: project.id, name: project.baseProjectName })}
                                          className="text-green-400 hover:text-green-600"
                                          aria-label="Release to Next Fix"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M21 5H9a7 7 0 0 0 0 14h2"></path></svg>
                                        </button>
                                    )}
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                ) : (
                  // User Tracker View
                  <div className="space-y-8">
                    <h1 className="text-4xl font-bold mb-8 text-center text-indigo-400">Project Time Tracker</h1>
                    {runningProject ? (
                      <div className="bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg border border-slate-700 mb-8 flex flex-col items-center text-center">
                        <h2 className="text-xl font-semibold text-slate-300">Currently Tracking</h2>
                        <p className="text-3xl md:text-4xl font-extrabold text-white my-4">{runningProject.baseProjectName}</p>
                        <p className="text-sm md:text-base text-slate-400 mb-2">
                          Area/Task: {runningProject.areaTask}
                        </p>
                        <div className="text-5xl md:text-6xl font-mono text-green-400 my-4">
                            {formatDuration((runningProject.durationDay1Ms || 0) + elapsedTime)}
                        </div>
                        <div className="flex space-x-4 mt-4">
                            <button
                                onClick={() => handlePauseResumeTimer(runningProject)}
                                className="bg-yellow-600 text-white p-4 rounded-full flex items-center justify-center shadow-md hover:bg-yellow-500 transition-colors"
                                aria-label="Pause Timer"
                            >
                                <PauseIcon className="w-8 h-8" />
                            </button>
                            <button
                                onClick={handleStartOrEndTimer}
                                className="bg-red-600 text-white p-4 rounded-full flex items-center justify-center shadow-md hover:bg-red-500 transition-colors"
                                aria-label="End Day"
                            >
                                <StopIcon className="w-8 h-8" />
                            </button>
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-left w-full mt-8">
                            <div className="bg-slate-700 p-4 rounded-xl">
                                <h3 className="text-sm font-semibold text-indigo-300 mb-1">Day 1 Duration</h3>
                                <p className="font-mono text-lg">{formatDuration(runningProject.durationDay1Ms)}</p>
                            </div>
                            <div className="bg-slate-700 p-4 rounded-xl">
                                <h3 className="text-sm font-semibold text-indigo-300 mb-1">Total Duration</h3>
                                <p className="font-mono text-lg">{formatDuration(getTaskTotalDuration(runningProject))}</p>
                            </div>
                        </div>
                      </div>
                    ) : (
                      <div className="bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg border border-slate-700 mb-8">
                        <h2 className="text-xl font-semibold mb-4 text-slate-300">Start a New Timer</h2>
                        <div className="flex flex-col sm:flex-row gap-4">
                            <div className="flex-grow">
                                <label htmlFor="project-select" className="block text-sm font-medium text-slate-400 mb-2">Select a Project</label>
                                <select
                                    id="project-select"
                                    value={selectedProjectName}
                                    onChange={(e) => {
                                        setSelectedProjectName(e.target.value);
                                        setSelectedTaskId('');
                                    }}
                                    className="w-full bg-slate-700 text-white p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"
                                >
                                    <option value="" disabled>Select a project...</option>
                                    {uniqueProjectNames.map((projectName) => (
                                        <option key={projectName} value={projectName}>
                                            {projectName}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-grow">
                                <label htmlFor="area-select" className="block text-sm font-medium text-slate-400 mb-2">Select an Area/Task</label>
                                <select
                                    id="area-select"
                                    value={selectedTaskId}
                                    onChange={(e) => setSelectedTaskId(e.target.value)}
                                    className="w-full bg-slate-700 text-white p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"
                                    disabled={!selectedProjectName}
                                >
                                    <option value="" disabled>Select an area...</option>
                                    {availableTasksForSelectedProject.map((task) => (
                                        <option key={task.id} value={task.id}>
                                            {task.areaTask}
                                        </option>
                                    ))}
                                </select>
                            </div>
                          <button
                            onClick={handleStartOrEndTimer}
                            disabled={!selectedTaskId}
                            className={`bg-indigo-600 text-white p-3 rounded-xl flex items-center justify-center shadow-md transition-colors self-end ${!selectedTaskId ? 'opacity-50 cursor-not-allowed' : 'hover:bg-indigo-500'}`}
                          >
                            <PlayIcon />
                          </button>
                        </div>
                        {uniqueProjectNames.length === 0 && (
                          <p className="text-center text-slate-500 italic py-8">
                            No available projects found. Add one in the TL Portal.
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                )}
        
              </div>
              {currentModal === 'confirmation' && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                  <div className="bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700 max-w-sm w-full text-center">
                    <p className="text-lg font-bold text-red-400 mb-4">
                      Confirm Action
                    </p>
                    <p className="text-slate-300 mb-6">
                      {modalData.action === 'delete' && `Are you sure you want to delete the project '${modalData.name}'? This cannot be undone.`}
                      {modalData.action === 'release' && `Are you sure you want to release task '${modalData.name}' to the next stage? This cannot be undone.`}
                    </p>
                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={handleModalAction}
                        className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-500"
                      >
                        Confirm
                      </button>
                      <button
                        onClick={() => setCurrentModal(null)}
                        className="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>
</body>
</html>

